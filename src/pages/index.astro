---
import clientPromise from "../lib/mongodb";
import { ObjectId } from "mongodb";

const userIdCookie = Astro.cookies.get("user_id");

if (!userIdCookie) {
  return Astro.redirect("/login");
}

const client = await clientPromise;
const db = client.db("frog_app");
const users = db.collection("users");

let user;
try {
  user = await users.findOne({ _id: new ObjectId(userIdCookie.value) });
} catch (e) {
}

if (!user) return Astro.redirect("/login");

let currentFrog = null;
let message = "";

if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();
  const action = formData.get("action");
  
  if (action === "like") {
    const urlToSave = formData.get("url");
    const idToSave = formData.get("id");
    
    await users.updateOne(
      { _id: user._id },
      { $addToSet: { favorites: { id: idToSave, url: urlToSave } } }
    );
    message = "Hop ! Ajout√©e aux favoris üíö";
  }
}

const accessKey = import.meta.env.UNSPLASH_ACCESS_KEY;
let attempts = 0;
let foundUnique = false;

while (!foundUnique && attempts < 3) {
  attempts++;
  
  try {
    const response = await fetch(`https://api.unsplash.com/photos/random?query=frog&orientation=portrait&client_id=${accessKey}`);
    
    if (response.ok) {
      const data = await response.json();
      const frogId = data.id;
      const frogUrl = data.urls.regular;

      const hasSeen = user.seen_images?.includes(frogId);

      if (!hasSeen) {
        currentFrog = { id: frogId, url: frogUrl, photographer: data.user.name };
        foundUnique = true;

        await users.updateOne(
          { _id: user._id },
          { $push: { seen_images: frogId } }
        );
      }
    } else {
        console.error("Erreur Unsplash", response.statusText);
        break; 
    }
  } catch (err) {
    console.error("Erreur fetch", err);
    break;
  }
}

if (!currentFrog) {
  currentFrog = { 
    id: "backup", 
    url: "https://images.unsplash.com/photo-1579389083046-e3df9c2b3325?auto=format&fit=crop&w=600&q=80", 
    photographer: "Backup Frog" 
  };
  message = "L'API se repose, voici une grenouille de secours.";
}

---

<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Froggy Love</title>
</head>
<body class="bg-stone-900 text-white min-h-screen flex flex-col items-center justify-center font-sans">

    <nav class="absolute top-0 w-full p-4 flex justify-between items-center bg-stone-800 shadow-md">
        <div class="text-green-400 font-bold text-xl">üê∏ Froggy</div>
        <div class="flex gap-4 text-sm">
            <span class="text-gray-300">Bonjour, {user.username}</span>
            <a href="/favorites" class="text-green-400 hover:text-green-300 transition">Mes Favoris</a>
            <form method="POST" action="/logout" style="display:inline;"> <button type="button" onclick="document.cookie='user_id=; Max-Age=0; path=/'; window.location.href='/login'" class="text-red-400 hover:text-red-300">D√©connexion</button>
            </form>
        </div>
    </nav>

    <main class="w-full max-w-md px-4 mt-16">
        
        {message && (
            <div class="mb-4 p-3 text-center bg-green-800 text-green-100 rounded-lg animate-bounce">
                {message}
            </div>
        )}

        <div class="bg-stone-800 rounded-2xl overflow-hidden shadow-2xl border border-stone-700 relative group">
            
            <div class="aspect-[3/4] w-full bg-stone-900 relative">
                <img 
                    src={currentFrog.url} 
                    alt="Une jolie grenouille" 
                    class="w-full h-full object-cover"
                />
                
                <div class="absolute bottom-2 right-2 text-xs text-white/50 bg-black/30 px-2 rounded">
                    Photo: {currentFrog.photographer}
                </div>
            </div>

            <div class="p-6 flex justify-between items-center bg-stone-800">
                
                <form method="POST">
                    <input type="hidden" name="action" value="next" />
                    <button type="submit" class="p-4 rounded-full bg-gray-700 hover:bg-gray-600 text-white transition transform hover:scale-110">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                        <span class="sr-only">Passer</span>
                    </button>
                </form>

                <div class="text-center">
                    <h2 class="text-xl font-bold text-green-400">Nouvelle amie ?</h2>
                    <p class="text-xs text-gray-400">D√©couvre ta prochaine grenouille</p>
                </div>

                <form method="POST">
                    <input type="hidden" name="action" value="like" />
                    <input type="hidden" name="url" value={currentFrog.url} />
                    <input type="hidden" name="id" value={currentFrog.id} />
                    <button type="submit" class="p-4 rounded-full bg-green-600 hover:bg-green-500 text-white shadow-lg shadow-green-900/50 transition transform hover:scale-110">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" />
                        </svg>
                        <span class="sr-only">J'aime</span>
                    </button>
                </form>
            </div>
        </div>
    </main>

</body>
</html>