---
import clientPromise from "../lib/mongodb";
import { ObjectId } from "mongodb";
import "../styles/global.css";

const userIdCookie = Astro.cookies.get("user_id");
if (!userIdCookie) return Astro.redirect("/login");

const client = await clientPromise;
const db = client.db("frog_app");
const users = db.collection("users");

let user;
try {
  user = await users.findOne({ _id: new ObjectId(userIdCookie.value) });
} catch (e) { return Astro.redirect("/login"); }

if (!user) return Astro.redirect("/login");

let currentFrog = null;
let message = "";

if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();
  const action = formData.get("action");
  
  if (action === "like") {
    const urlToSave = formData.get("url");
    const idToSave = formData.get("id");
    await users.updateOne(
      { _id: user._id },
      { $addToSet: { favorites: { id: idToSave, url: urlToSave } } }
    );
    message = "Ajout√©e √† ta collection ! ‚ú®";
  }
}

const accessKey = import.meta.env.UNSPLASH_ACCESS_KEY;
let attempts = 0;
let foundUnique = false;

while (!foundUnique && attempts < 3) {
  attempts++;
  try {
    const response = await fetch(`https://api.unsplash.com/photos/random?query=frog&orientation=portrait&client_id=${accessKey}`);
    if (response.ok) {
      const data = await response.json();
      const frogId = data.id;
      const frogUrl = data.urls.regular;
      const hasSeen = user.seen_images?.includes(frogId);

      if (!hasSeen) {
        currentFrog = { id: frogId, url: frogUrl, photographer: data.user.name, download: data.links.html };
        foundUnique = true;
        await users.updateOne({ _id: user._id }, { $push: { seen_images: frogId } });
      }
    } else { break; }
  } catch (err) { break; }
}

if (!currentFrog) {
  currentFrog = { id: "backup", url: "https://images.unsplash.com/photo-1579389083046-e3df9c2b3325", photographer: "Backup Frog" };
}
---

<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Froggy Love</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Nunito', sans-serif; }
        ::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-gray-900 min-h-[100dvh] text-white overflow-hidden relative">

    <div class="absolute inset-0 opacity-30 pointer-events-none">
        <div class="absolute top-[-10%] left-[-10%] w-96 h-96 bg-green-500 rounded-full blur-[100px]"></div>
        <div class="absolute bottom-[-10%] right-[-10%] w-96 h-96 bg-emerald-600 rounded-full blur-[100px]"></div>
    </div>

    <main class="relative z-10 h-[100dvh] flex flex-col p-4 pb-24 max-w-2xl mx-auto w-full">
        
        <header class="flex-none flex justify-between items-center py-2 mb-2">
            <div class="flex flex-col">
                <span class="text-[10px] text-emerald-400 font-bold tracking-widest uppercase">D√©couverte</span>
                <h1 class="text-2xl font-black">Froggy üê∏</h1>
            </div>
            <div class="flex items-center gap-3">
                <a href="/logout" class="px-4 py-2 text-xs font-bold text-white bg-red-600/50 hover:bg-red-600 border border-red-500/50 rounded-full transition-all">
                    D√©connexion
                </a>
                <div class="w-10 h-10 rounded-full bg-white/10 backdrop-blur-md flex items-center justify-center border border-white/10">
                    <span class="text-lg text-white font-bold">{user.username.charAt(0).toUpperCase()}</span>
                </div>
            </div>
        </header>

        <div class="flex-1 min-h-0 relative w-full bg-black rounded-3xl overflow-hidden shadow-2xl border border-white/10 group mx-auto md:max-w-sm md:aspect-[3/4]">
            
            {message && (
                <div class="absolute top-4 left-1/2 -translate-x-1/2 z-20 bg-emerald-500/90 backdrop-blur px-4 py-2 rounded-full text-xs font-bold shadow-lg animate-bounce text-white whitespace-nowrap">
                    {message}
                </div>
            )}

            <img 
                src={currentFrog.url} 
                class="absolute inset-0 w-full h-full object-cover"
                alt="Frog"
            />
            
            <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-transparent to-transparent"></div>

            <div class="absolute bottom-0 left-0 w-full p-6">
                <p class="text-emerald-400 text-[10px] font-bold uppercase tracking-wider mb-1">Photographe</p>
                <h2 class="text-xl font-bold text-white mb-1 leading-tight">{currentFrog.photographer}</h2>
            </div>
        </div>

        <div class="flex-none mt-6 flex justify-center items-center gap-8 h-24">
            <form method="POST">
                <input type="hidden" name="action" value="next" />
                <button type="submit" class="w-16 h-16 flex items-center justify-center rounded-full bg-gray-800/50 backdrop-blur text-white border border-white/10 hover:bg-red-500/20 hover:border-red-500 transition-all active:scale-90 shadow-lg">
                    ‚ùå
                </button>
            </form>

            <form method="POST">
                <input type="hidden" name="action" value="like" />
                <input type="hidden" name="url" value={currentFrog.url} />
                <input type="hidden" name="id" value={currentFrog.id} />
                <button type="submit" class="w-20 h-20 flex items-center justify-center rounded-full bg-gradient-to-tr from-emerald-500 to-green-400 text-white shadow-[0_0_20px_rgba(16,185,129,0.4)] hover:scale-105 transition-all active:scale-95 text-3xl border-4 border-black">
                    üíö
                </button>
            </form>
        </div>
    </main>

    <nav class="fixed bottom-0 left-0 w-full bg-black/80 backdrop-blur-xl border-t border-white/5 flex justify-around py-4 z-50">
        <a href="/" class="flex flex-col items-center gap-1 text-emerald-400">
            <span class="text-xl">üè†</span>
            <span class="text-[10px] font-bold">Accueil</span>
        </a>
        <a href="/favorites" class="flex flex-col items-center gap-1 text-gray-500 hover:text-white transition">
            <span class="text-xl">‚ù§Ô∏è</span>
            <span class="text-[10px] font-bold">Favoris</span>
        </a>
    </nav>

</body>
</html>