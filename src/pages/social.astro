---
import clientPromise from "../lib/mongodb";
import { ObjectId } from "mongodb";
import "../styles/global.css";

const userIdCookie = Astro.cookies.get("user_id");
if (!userIdCookie) return Astro.redirect("/login");

const client = await clientPromise;
const db = client.db("frog_app");
const users = db.collection("users");

let user;
try {
  user = await users.findOne({ _id: new ObjectId(userIdCookie.value) });
} catch (e) { return Astro.redirect("/login"); }

if (!user) return Astro.redirect("/login");

let message = "";
let error = "";
let activeTab = "friends";

const url = new URL(Astro.request.url);
const tabParam = url.searchParams.get("tab");
if (tabParam === "search" || tabParam === "requests") {
  activeTab = tabParam;
}

const viewFriendId = url.searchParams.get("view");
let viewingFriend = null;
let viewingFriendFavorites: any[] = [];

if (viewFriendId) {
  try {
    viewingFriend = await users.findOne({ _id: new ObjectId(viewFriendId) });
    if (viewingFriend) {
      viewingFriendFavorites = viewingFriend.favorites || [];
    }
  } catch (e) {
    console.error("Invalid friend ID");
  }
}

if (Astro.request.method === "POST") {
  const formData = await Astro.request.formData();
  const action = formData.get("action");
  
  if (action === "add_friend") {
    const friendUsername = formData.get("username")?.toString().trim().toLowerCase();
    
    if (friendUsername === user.username.toLowerCase()) {
      error = "Tu ne peux pas t'ajouter toi-m√™me en ami ! üòÖ";
    } else {
      const friendUser = await users.findOne({ 
        username: { $regex: new RegExp(`^${friendUsername}$`, 'i') }
      });
      
      if (!friendUser) {
        error = "Aucun utilisateur trouv√© avec ce pseudo.";
      } else {
        const alreadyFriends = user.friends?.some((f: any) => f.id === friendUser._id.toString());
        
        if (alreadyFriends) {
          error = "Vous √™tes d√©j√† amis ! üê∏";
        } else {
          await users.updateOne(
            { _id: friendUser._id },
            { $addToSet: { friendRequests: { id: user._id.toString(), username: user.username, date: new Date() } } }
          );
          
          message = `Demande d'ami envoy√©e √† ${friendUser.username} ! üì®`;
        }
      }
    }
    activeTab = "search";
  }
  
  if (action === "accept_request") {
    const requesterId = formData.get("requesterId")?.toString();
    
    if (requesterId) {
      const requester = await users.findOne({ _id: new ObjectId(requesterId) });
      
      if (requester) {
        await users.updateOne(
          { _id: user._id },
          { 
            $addToSet: { 
              friends: { 
                id: requester._id.toString(), 
                username: requester.username,
                displayName: requester.displayName || requester.username,
                emoji: requester.favoriteEmoji || 'üê∏',
                addedAt: new Date()
              } 
            },
            $pull: { friendRequests: { id: requesterId } }
          }
        );
        
        await users.updateOne(
          { _id: requester._id },
          { 
            $addToSet: { 
              friends: { 
                id: user._id.toString(), 
                username: user.username,
                displayName: user.displayName || user.username,
                emoji: user.favoriteEmoji || 'üê∏',
                addedAt: new Date()
              } 
            }
          }
        );
        
        message = `${requester.username} et toi √™tes maintenant amis ! üéâ`;
      }
    }
    activeTab = "requests";
  }
  
  if (action === "reject_request") {
    const requesterId = formData.get("requesterId")?.toString();
    
    if (requesterId) {
      await users.updateOne(
        { _id: user._id },
        { $pull: { friendRequests: { id: requesterId } } }
      );
      
      message = "Demande refus√©e.";
    }
    activeTab = "requests";
  }
  
  if (action === "remove_friend") {
    const friendId = formData.get("friendId")?.toString();
    
    if (friendId) {
      await users.updateOne(
        { _id: user._id },
        { $pull: { friends: { id: friendId } } }
      );
      
      await users.updateOne(
        { _id: new ObjectId(friendId) },
        { $pull: { friends: { id: user._id.toString() } } }
      );
      
      message = "Ami supprim√©.";
    }
  }
  
  user = await users.findOne({ _id: user._id });
}

const friends = user.friends || [];
const friendRequests = user.friendRequests || [];
---

<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Espace Social - Froggy</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Nunito', sans-serif; }
    </style>
</head>
<body class="bg-slate-950 min-h-screen text-white pb-24">

    <!-- Aquatic Background -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
        <div class="absolute inset-0 bg-gradient-to-b from-slate-950 via-blue-950/20 to-indigo-950/30"></div>
        
        <div class="absolute top-[-15%] right-[-10%] w-[500px] h-[500px] bg-indigo-600/20 rounded-full blur-[120px] animate-blob"></div>
        <div class="absolute bottom-[-10%] left-[-15%] w-[400px] h-[400px] bg-cyan-500/15 rounded-full blur-[100px] animate-blob" style="animation-delay: -4s;"></div>
        <div class="absolute top-1/3 left-1/4 w-[300px] h-[300px] bg-blue-500/10 rounded-full blur-[80px] animate-blob" style="animation-delay: -7s;"></div>
        
        <div class="absolute bottom-0 left-[25%] w-3 h-3 bg-cyan-400/25 rounded-full animate-bubble" style="animation-delay: 1s;"></div>
        <div class="absolute bottom-0 right-[40%] w-4 h-4 bg-blue-400/20 rounded-full animate-bubble" style="animation-delay: 3s;"></div>
    </div>

    <!-- Header -->
    <nav class="sticky top-0 z-40 bg-slate-950/70 backdrop-blur-xl border-b border-cyan-500/10">
        <div class="max-w-2xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                {viewingFriend ? (
                    <a href="/social" class="text-cyan-300/50 hover:text-white transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                        </svg>
                    </a>
                ) : (
                    <a href="/" class="text-cyan-300/50 hover:text-white transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
                        </svg>
                    </a>
                )}
                <div>
                    <h1 class="text-xl font-black bg-gradient-to-r from-blue-300 via-indigo-300 to-purple-300 bg-clip-text text-transparent">
                        {viewingFriend ? `Collection de ${viewingFriend.displayName || viewingFriend.username}` : 'Espace Social'}
                    </h1>
                    {!viewingFriend && (
                        <p class="text-xs text-cyan-300/40">{friends.length} ami{friends.length > 1 ? 's' : ''}</p>
                    )}
                </div>
            </div>
            {friendRequests.length > 0 && !viewingFriend && (
                <a href="/social?tab=requests" class="relative">
                    <div class="w-10 h-10 rounded-full bg-indigo-500/20 flex items-center justify-center">
                        <span class="text-lg">üîî</span>
                    </div>
                    <div class="absolute -top-1 -right-1 w-5 h-5 rounded-full bg-red-500 flex items-center justify-center text-[10px] font-bold">
                        {friendRequests.length}
                    </div>
                </a>
            )}
        </div>
    </nav>

    <main class="relative z-10 max-w-2xl mx-auto px-4 py-6">

        <!-- Messages -->
        {message && (
            <div class="mb-6 p-4 rounded-xl bg-cyan-500/20 border border-cyan-500/30 animate-slide-up">
                <div class="flex items-center gap-3">
                    <span class="text-xl">‚úÖ</span>
                    <span class="text-cyan-300 font-semibold text-sm">{message}</span>
                </div>
            </div>
        )}

        {error && (
            <div class="mb-6 p-4 rounded-xl bg-red-500/20 border border-red-500/30 animate-slide-up">
                <div class="flex items-center gap-3">
                    <span class="text-xl">‚ö†Ô∏è</span>
                    <span class="text-red-300 font-semibold text-sm">{error}</span>
                </div>
            </div>
        )}

        {viewingFriend ? (
            <!-- Viewing Friend's Collection -->
            <Fragment>
                <div class="glass rounded-2xl p-6 mb-6 animate-slide-up border border-indigo-500/10">
                    <div class="flex items-center gap-4">
                        <div class="w-16 h-16 rounded-xl bg-gradient-to-br from-indigo-400 to-blue-500 flex items-center justify-center shadow-lg">
                            <span class="text-3xl">{viewingFriend.favoriteEmoji || 'üê∏'}</span>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-white">{viewingFriend.displayName || viewingFriend.username}</h2>
                            <p class="text-cyan-300/50 text-sm">@{viewingFriend.username}</p>
                            {viewingFriend.bio && (
                                <p class="text-cyan-100/60 text-xs mt-1">{viewingFriend.bio}</p>
                            )}
                        </div>
                    </div>
                    <div class="flex items-center gap-2 mt-4 text-sm text-cyan-300/50">
                        <span class="text-cyan-400 font-bold">{viewingFriendFavorites.length}</span> grenouilles dans sa collection
                    </div>
                </div>

                {viewingFriendFavorites.length === 0 ? (
                    <div class="text-center py-20 animate-slide-up">
                        <div class="text-6xl mb-4">üê∏</div>
                        <h3 class="text-lg font-bold text-white mb-2">Collection vide</h3>
                        <p class="text-cyan-300/50 text-sm">{viewingFriend.username} n'a pas encore sauvegard√© de grenouilles.</p>
                    </div>
                ) : (
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                        {viewingFriendFavorites.map((frog: any, index: number) => (
                            <div 
                                class="relative rounded-xl overflow-hidden aspect-[3/4] bg-slate-900 border border-indigo-500/10 animate-slide-up"
                                style={`animation-delay: ${index * 0.05}s;`}
                            >
                                <img 
                                    src={frog.url} 
                                    alt="Grenouille" 
                                    class="w-full h-full object-cover"
                                    loading="lazy"
                                />
                            </div>
                        ))}
                    </div>
                )}
            </Fragment>
        ) : (
            <!-- Main Social Hub -->
            <Fragment>
                <!-- Tabs -->
                <div class="flex gap-2 mb-6 p-1 bg-white/5 rounded-xl animate-slide-up border border-indigo-500/10">
                    <a 
                        href="/social?tab=friends" 
                        class={`flex-1 py-3 px-4 rounded-lg text-center text-sm font-bold transition-all ${activeTab === 'friends' ? 'bg-indigo-500/30 text-indigo-300' : 'text-cyan-300/50 hover:text-white'}`}
                    >
                        üë• Mes amis
                    </a>
                    <a 
                        href="/social?tab=search" 
                        class={`flex-1 py-3 px-4 rounded-lg text-center text-sm font-bold transition-all ${activeTab === 'search' ? 'bg-indigo-500/30 text-indigo-300' : 'text-cyan-300/50 hover:text-white'}`}
                    >
                        üîç Rechercher
                    </a>
                    <a 
                        href="/social?tab=requests" 
                        class={`flex-1 py-3 px-4 rounded-lg text-center text-sm font-bold transition-all relative ${activeTab === 'requests' ? 'bg-indigo-500/30 text-indigo-300' : 'text-cyan-300/50 hover:text-white'}`}
                    >
                        üì® Demandes
                        {friendRequests.length > 0 && (
                            <span class="absolute -top-1 -right-1 w-5 h-5 rounded-full bg-red-500 flex items-center justify-center text-[10px] font-bold text-white">
                                {friendRequests.length}
                            </span>
                        )}
                    </a>
                </div>

                <!-- Friends Tab -->
                {activeTab === 'friends' && (
                    <div class="space-y-3 animate-slide-up">
                        {friends.length === 0 ? (
                            <div class="text-center py-16">
                                <div class="text-6xl mb-4 animate-float">üë•</div>
                                <h3 class="text-lg font-bold text-white mb-2">Aucun ami pour l'instant</h3>
                                <p class="text-cyan-300/50 text-sm mb-6">Ajoute des amis pour voir leurs collections de grenouilles !</p>
                                <a href="/social?tab=search" class="inline-flex items-center gap-2 px-6 py-3 bg-indigo-500/20 hover:bg-indigo-500/30 border border-indigo-500/30 rounded-full text-indigo-300 font-bold transition-all">
                                    <span>üîç</span> Trouver des amis
                                </a>
                            </div>
                        ) : (
                            friends.map((friend: any) => (
                                <div class="glass rounded-xl p-4 flex items-center justify-between group hover:bg-white/10 transition-all border border-indigo-500/10">
                                    <a href={`/social?view=${friend.id}`} class="flex items-center gap-4 flex-1">
                                        <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-indigo-400 to-blue-500 flex items-center justify-center shadow-lg group-hover:scale-105 transition-transform">
                                            <span class="text-2xl">{friend.emoji || 'üê∏'}</span>
                                        </div>
                                        <div>
                                            <p class="font-bold text-white group-hover:text-indigo-300 transition-colors">{friend.displayName || friend.username}</p>
                                            <p class="text-xs text-cyan-300/50">@{friend.username}</p>
                                        </div>
                                    </a>
                                    <div class="flex items-center gap-2">
                                        <a href={`/social?view=${friend.id}`} class="px-4 py-2 bg-indigo-500/20 hover:bg-indigo-500/30 text-indigo-300 text-xs font-bold rounded-full transition-all">
                                            Voir collection
                                        </a>
                                        <form method="POST">
                                            <input type="hidden" name="action" value="remove_friend" />
                                            <input type="hidden" name="friendId" value={friend.id} />
                                            <button type="submit" class="w-10 h-10 rounded-full bg-red-500/10 hover:bg-red-500/20 text-red-400 flex items-center justify-center transition-all" title="Supprimer">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                                </svg>
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>
                )}

                <!-- Search Tab -->
                {activeTab === 'search' && (
                    <div class="animate-slide-up">
                        <div class="glass rounded-2xl p-6 mb-6 border border-indigo-500/10">
                            <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
                                <span>üîç</span> Ajouter un ami
                            </h3>
                            <form method="POST" class="space-y-4">
                                <input type="hidden" name="action" value="add_friend" />
                                <div class="relative">
                                    <input 
                                        type="text" 
                                        name="username" 
                                        placeholder="Pseudo de ton ami..."
                                        class="w-full px-5 py-4 bg-white/5 border border-indigo-500/20 rounded-xl text-white placeholder-cyan-200/30 focus:outline-none focus:border-indigo-400/50 focus:bg-white/10 transition-all pr-24"
                                        required
                                    />
                                    <button type="submit" class="absolute right-2 top-1/2 -translate-y-1/2 px-4 py-2 bg-indigo-500 hover:bg-indigo-400 text-white text-sm font-bold rounded-lg transition-all">
                                        Envoyer
                                    </button>
                                </div>
                            </form>
                        </div>

                        <div class="text-center py-8 text-cyan-300/40">
                            <div class="text-4xl mb-4">üí°</div>
                            <p class="text-sm">Entre le pseudo exact de la personne que tu veux ajouter.</p>
                            <p class="text-xs mt-2">Elle recevra une demande d'ami qu'elle pourra accepter ou refuser.</p>
                        </div>
                    </div>
                )}

                <!-- Requests Tab -->
                {activeTab === 'requests' && (
                    <div class="space-y-3 animate-slide-up">
                        {friendRequests.length === 0 ? (
                            <div class="text-center py-16">
                                <div class="text-6xl mb-4">üì≠</div>
                                <h3 class="text-lg font-bold text-white mb-2">Aucune demande</h3>
                                <p class="text-cyan-300/50 text-sm">Tu n'as pas de demandes d'ami en attente.</p>
                            </div>
                        ) : (
                            friendRequests.map((request: any) => (
                                <div class="glass rounded-xl p-4 flex items-center justify-between border border-indigo-500/10">
                                    <div class="flex items-center gap-4">
                                        <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-400 to-indigo-500 flex items-center justify-center">
                                            <span class="text-xl">üê∏</span>
                                        </div>
                                        <div>
                                            <p class="font-bold text-white">{request.username}</p>
                                            <p class="text-xs text-cyan-300/50">Veut √™tre ton ami</p>
                                        </div>
                                    </div>
                                    <div class="flex gap-2">
                                        <form method="POST">
                                            <input type="hidden" name="action" value="accept_request" />
                                            <input type="hidden" name="requesterId" value={request.id} />
                                            <button type="submit" class="w-10 h-10 rounded-full bg-cyan-500/20 hover:bg-cyan-500/30 text-cyan-400 flex items-center justify-center transition-all">
                                                ‚úì
                                            </button>
                                        </form>
                                        <form method="POST">
                                            <input type="hidden" name="action" value="reject_request" />
                                            <input type="hidden" name="requesterId" value={request.id} />
                                            <button type="submit" class="w-10 h-10 rounded-full bg-red-500/20 hover:bg-red-500/30 text-red-400 flex items-center justify-center transition-all">
                                                ‚úó
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            ))
                        )}
                    </div>
                )}
            </Fragment>
        )}

    </main>

    <!-- Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 w-full bg-slate-950/80 backdrop-blur-xl border-t border-cyan-500/10 flex justify-around py-4 z-50">
        <a href="/" class="flex flex-col items-center gap-1 text-slate-500 hover:text-white transition-colors">
            <span class="text-xl">üè†</span>
            <span class="text-[10px] font-bold">Accueil</span>
        </a>
        <a href="/favorites" class="flex flex-col items-center gap-1 text-slate-500 hover:text-white transition-colors">
            <span class="text-xl">‚ù§Ô∏è</span>
            <span class="text-[10px] font-bold">Favoris</span>
        </a>
        <a href="/social" class="flex flex-col items-center gap-1 text-indigo-400">
            <div class="relative">
                <span class="absolute -inset-2 bg-indigo-500/20 rounded-full blur-md"></span>
                <span class="relative text-xl">üë•</span>
                {friendRequests.length > 0 && (
                    <div class="absolute -top-2 -right-2 w-4 h-4 rounded-full bg-red-500 flex items-center justify-center text-[8px] font-bold text-white">
                        {friendRequests.length}
                    </div>
                )}
            </div>
            <span class="text-[10px] font-bold">Social</span>
        </a>
        <a href="/profile" class="flex flex-col items-center gap-1 text-slate-500 hover:text-white transition-colors">
            <span class="text-xl">üë§</span>
            <span class="text-[10px] font-bold">Profil</span>
        </a>
    </nav>

</body>
</html>
